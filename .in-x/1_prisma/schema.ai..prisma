generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User identified by wallet address
model User {
  id              String        @id @default(cuid())
  walletAddress   String        @unique
  role            UserRole      @default(USER)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relationships
  createdCases    Case[]        @relation("UserCases")
  votes           Vote[]
  reviews         Review[]
  tokenBalance    TokenBalance?
  
  // Indexes
  @@index([walletAddress])
  @@index([role])
}

// Arbitrator with locked funds
model Arbitrator {
  id                String        @id @default(cuid())
  walletAddress     String        @unique
  name              String?
  
  // Verification flags
  isKYCVerified     Boolean       @default(false)
  isQualified       Boolean       @default(false)  // Manual qualification check
  qualificationScore Int          @default(0)      // 0-100 score
  isActive          Boolean       @default(true)
  
  // Locked funds (stake)
  lockedAmount      BigInt        @default(0)      // in lovelace
  lockedTxHash      String?       // Transaction where funds locked
  
  // Token incentives
  totalEarned       BigInt        @default(0)
  totalLost         BigInt        @default(0)
  
  // Performance stats
  totalCases        Int           @default(0)
  correctVotes      Int           @default(0)
  wrongVotes        Int           @default(0)
  reputationScore   Float         @default(0.5)    // 0-1 score
  
  
  // Timestamps
  registeredAt      DateTime      @default(now())
  lastActiveAt      DateTime?
  updatedAt         DateTime      @updatedAt
  
  // Relationships
  user              User          @relation(fields: [walletAddress], references: [walletAddress])
  votes             Vote[]
  
  // Indexes
  @@index([reputationScore])
  @@index([isQualified])
  @@index([isActive])
  @@index([lockedAmount])
}

// Escrow Case
model Case {
  id                String        @id @default(cuid())
  
  // Blockchain data
  txHash            String        @unique
  scriptAddress     String
  amount            BigInt        // in lovelace
  status            CaseStatus    @default(ACTIVE)
  
  // Parties
  funderAddress     String
  recipientAddress  String
  creatorId         String
  creator           User          @relation("UserCases", fields: [creatorId], references: [id])
  
  // Dispute
  isDisputed        Boolean       @default(false)
  disputeRaisedAt   DateTime?
  disputeReason     String?
  
  // Arbitration
  arbitratorsAssigned Boolean     @default(false)
  totalArbitrators   Int          @default(3)     // How many arbitrators assigned
  votesCollected    Int           @default(0)     // How many votes received
  
  // Decision
  decision          DecisionType?
  releaseAmount     BigInt?
  refundAmount      BigInt?
  finalVoteResult   VoteResult?   // Based on majority
  
  // Majorities tracking
  releaseVotes      Int           @default(0)
  refundVotes       Int           @default(0)
  splitVotes        Int           @default(0)
  
  // Resolution
  resolutionTxHash  String?
  
  // Timelines
  createdAt         DateTime      @default(now())
  deadline          DateTime      // Dispute deadline
  decisionDeadline  DateTime?     // When arbitrators must decide
  resolvedAt        DateTime?
  updatedAt         DateTime      @updatedAt
  
  // Relationships
  votes             Vote[]
  reviews           Review[]
  evidence          Evidence[]
  
  // Indexes
  @@index([txHash])
  @@index([funderAddress])
  @@index([recipientAddress])
  @@index([status])
  @@index([isDisputed])
  @@index([deadline])
}

// Individual votes by arbitrators
model Vote {
  id                String        @id @default(cuid())
  caseId            String
  case              Case          @relation(fields: [caseId], references: [id])
  
  arbitratorId      String
  arbitrator        Arbitrator    @relation(fields: [arbitratorId], references: [id])
  
  voterId           String
  voter             User          @relation(fields: [voterId], references: [id])
  
  vote              DecisionType
  reason            String?
  confidence        Int           @default(50)  // 0-100 how confident
  
  // Was this vote in majority?
  isInMajority      Boolean       @default(false)
  rewardAmount      BigInt        @default(0)   // Tokens earned/lost
  
  // Timestamp
  votedAt           DateTime      @default(now())
  
  // Unique constraint - one vote per arbitrator per case
  @@unique([caseId, arbitratorId])
  
  // Indexes
  @@index([caseId])
  @@index([arbitratorId])
  @@index([vote])
  @@index([isInMajority])
}

// Evidence for cases
model Evidence {
  id                String        @id @default(cuid())
  caseId            String
  case              Case          @relation(fields: [caseId], references: [id])
  
  uploadedById      String
  uploadedBy        User          @relation(fields: [uploadedById], references: [id])
  
  // Evidence details
  fileName          String
  fileUrl           String        // IPFS or storage URL
  description       String?
  fileType          String
  fileSize          Int
  
  // Timestamps
  uploadedAt        DateTime      @default(now())
  
  // Indexes
  @@index([caseId])
  @@index([uploadedById])
}

// Reviews after case resolution
model Review {
  id                String        @id @default(cuid())
  caseId            String
  case              Case          @relation(fields: [caseId], references: [id])
  
  reviewerId        String
  reviewer          User          @relation(fields: [reviewerId], references: [id])
  
  // Ratings
  rating            Int           @default(3)  // 1-5 stars
  comment           String?
  
  // Was review helpful?
  helpfulVotes      Int           @default(0)
  unhelpfulVotes    Int           @default(0)
  
  // Timestamp
  reviewedAt        DateTime      @default(now())
  
  // Unique constraint - one review per user per case
  @@unique([caseId, reviewerId])
  
  // Indexes
  @@index([caseId])
  @@index([reviewerId])
  @@index([rating])
}

// Token balances for users (simplified)
model TokenBalance {
  id                String        @id @default(cuid())
  userId            String        @unique
  user              User          @relation(fields: [userId], references: [id])
  
  balance           BigInt        @default(0)
  earnedTotal       BigInt        @default(0)
  spentTotal        BigInt        @default(0)
  
  // Locked tokens (for arbitration stakes)
  lockedBalance     BigInt        @default(0)
  
  // Last update
  updatedAt         DateTime      @updatedAt
}

// System settings (token amounts, deadlines, etc.)
model SystemConfig {
  id                String        @id @default(cuid())
  key               String        @unique
  value             String
  description       String?
  
  // Indexes
  @@index([key])
}

// Pending arbitrator applications
model ArbitratorApplication {
  id                String        @id @default(cuid())
  walletAddress     String        @unique
  name              String
  email             String?
  experience        String?
  
  // Lock amount they're willing to stake
  proposedStake     BigInt
  
  // Status
  status            ApplicationStatus @default(PENDING)
  reviewedBy        String?
  reviewNotes       String?
  
  // Timestamps
  appliedAt         DateTime      @default(now())
  reviewedAt        DateTime?
  
  // Indexes
  @@index([status])
  @@index([appliedAt])
}

// Enums
enum UserRole {
  USER
  ARBITRATOR
  ADMIN
}

enum CaseStatus {
  ACTIVE
  DISPUTED
  VOTING
  RESOLVED
  CANCELLED
  EXPIRED
}

enum DecisionType {
  RELEASE  // Give to recipient
  REFUND   // Return to funder
  SPLIT    // Split between both
}

enum VoteResult {
  RELEASE_WON
  REFUND_WON
  SPLIT_WON
  NO_MAJORITY
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}