generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  role          UserRole @default(USER)
  network       String   @default("preprod")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  arbitrator         Arbitrator?
  escrows            Escrow[]
  disputes           Dispute[]
  resolutions        Resolution[]
  activityLogs       ActivityLog[]
  escrowTransactions EscrowTransaction[]

  @@index([walletAddress])
  @@index([role])
  @@index([network])
}

model Arbitrator {
  id                  String   @id @default(cuid())
  walletAddress       String   @unique
  name                String?
  bio                 String?
  expertise           String[]
  isQualified         Boolean  @default(false)
  qualificationScore  Int      @default(0)
  isActive            Boolean  @default(true)
  lockedAmount        BigInt   @default(0)
  lockedTxHash        String?
  totalEarned         BigInt   @default(0)
  totalLost           BigInt   @default(0)
  totalCases          Int      @default(0)
  correctVotes        Int      @default(0)
  wrongVotes          Int      @default(0)
  reputationScore     Float    @default(0.5)
  registeredAt        DateTime @default(now())
  lastActiveAt        DateTime?
  updatedAt           DateTime @updatedAt

  user        User         @relation(fields: [walletAddress], references: [walletAddress])
  resolutions Resolution[]
  disputes    Dispute[]    @relation("ArbitratorDisputes")
  votes       Vote[]

  @@index([reputationScore])
  @@index([isQualified])
  @@index([isActive])
  @@index([lockedAmount])
}

model Escrow {
  id                    String   @id @default(cuid())
  txHash                String   @unique
  scriptAddress         String
  amount                BigInt
  amountAda             Float
  funderAddress         String
  funderPubKeyHash      String?
  recipientAddress      String
  recipientPubKeyHash   String?
  status                EscrowStatus @default(AWAITING_RECIPIENT)
  disputeDeadline       DateTime?
  recipientLockDeadline DateTime?
  datum                 Json
  contractIpfsHash      String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lockedAt              DateTime @default(now())
  resolutionDeadline    DateTime?
  datumHash             String?
  scriptCbor            String?
  confirmations         Int      @default(0)
  blockHeight           Int?
  blockHash             String?
  approvedAt            DateTime?
  disputedAt            DateTime?
  resolvedAt            DateTime?

  userId             String?
  user               User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  dispute            Dispute?
  resolution         Resolution?
  escrowTransactions EscrowTransaction[]

  @@index([txHash])
  @@index([funderAddress])
  @@index([recipientAddress])
  @@index([status])
  @@index([createdAt])
}

model EscrowTransaction {
  id       String @id @default(cuid())
  txHash   String @unique
  user     User   @relation(fields: [userId], references: [id])
  userId   String
  reason   String
  escrow   Escrow @relation(fields: [escrowId], references: [id])
  escrowId String
}

model Dispute {
  id                    String          @id @default(cuid())
  escrowId              String          @unique
  escrow                Escrow          @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  raisedBy              DisputeRaisedBy
  raisedById            String?
  raisedByAddress       String
  reason                String?
  evidence              String?
  txHash                String?
  status                DisputeStatus   @default(PENDING)
  requiredArbitratorCount Int           @default(3)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  resolvedAt            DateTime?
  resolutionDeadline    DateTime?

  votes       Vote[]
  resolution  Resolution?
  user        User?    @relation(fields: [userId], references: [id])
  userId      String?
  arbitrators Arbitrator[] @relation("ArbitratorDisputes")

  @@index([escrowId])
  @@index([raisedByAddress])
  @@index([status])
  @@index([createdAt])
}

model Vote {
  id            String   @id @default(cuid())
  disputeId     String
  dispute       Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  arbitratorId  String
  arbitrator    Arbitrator @relation(fields: [arbitratorId], references: [id], onDelete: Cascade)
  decision      ResolutionResult
  reason        String?
  txHash        String?
  createdAt     DateTime @default(now())

  @@unique([disputeId, arbitratorId])
  @@index([disputeId])
  @@index([arbitratorId])
  @@index([decision])
}

model Resolution {
  id                String         @id @default(cuid())
  escrowId          String         @unique
  escrow            Escrow         @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  type              ResolutionType
  result            ResolutionResult
  resolvedBy        ResolutionBy
  resolvedById      String?
  resolvedByAddress String
  arbitratorId      String?
  arbitrator        Arbitrator?    @relation(fields: [arbitratorId], references: [id])
  payoutAddress     String
  payoutAmount      BigInt
  payoutAmountAda   Float
  txHash            String
  createdAt         DateTime       @default(now())
  resolvedAt        DateTime       @default(now())

  disputeId String?  @unique
  dispute   Dispute? @relation(fields: [disputeId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([escrowId])
  @@index([txHash])
  @@index([resolvedByAddress])
  @@index([createdAt])
}

model ActivityLog {
  id                  String     @id @default(cuid())
  entityType          EntityType
  entityId            String
  action              String
  performedBy         String
  performedByAddress  String?
  metadata            Json?
  txHash              String?
  createdAt           DateTime   @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([performedBy])
  @@index([createdAt])
}

enum UserRole {
  USER
  ARBITRATOR
  ADMIN
}

enum EscrowStatus {
  AWAITING_RECIPIENT
  ACTIVE
  APPROVED
  DISPUTED
  RESOLVED
  EXPIRED
  CANCELLED
}

enum DisputeStatus {
  PENDING
  ASSIGNED
  IN_REVIEW
  RESOLVED
  EXPIRED
}

enum DisputeRaisedBy {
  FUNDER
  RECIPIENT
}

enum ResolutionType {
  DIRECT_RELEASE
  DIRECT_REFUND
  ARBITRATED_RELEASE
  ARBITRATED_REFUND
}

enum ResolutionResult {
  RELEASE
  REFUND
}

enum ResolutionBy {
  FUNDER
  RECIPIENT
  ARBITRATOR
}

enum EntityType {
  USER
  ARBITRATOR
  ESCROW
  DISPUTE
  RESOLUTION
}